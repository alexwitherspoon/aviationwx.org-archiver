{% extends "base.html" %}
{% block title %}Browse Archive — AviationWX Archiver{% endblock %}

{% block content %}
<h1>Browse Archive</h1>
<p class="subtitle">Explore archived images organised by airport / year / month / day / camera</p>

<style>
  .file-link { color: var(--accent); text-decoration: none; }
  .file-link:hover { text-decoration: underline; }
  #preview-nav button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>
<div id="preview-panel" class="card" style="display:none; margin-bottom:24px;" tabindex="-1">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:12px;">
    <div>
      <h2 style="margin-bottom:4px;">Preview</h2>
      <p style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; color:var(--text-muted); font-size:12px;">
        <span id="preview-filename"></span>
        <span id="preview-timestamp" style="color:var(--accent);"></span>
      </p>
    </div>
    <div style="display:flex; flex-wrap:wrap; align-items:center; gap:12px;">
      <div id="preview-nav" style="display:none; align-items:center; gap:12px;">
        <button id="prev-btn" type="button" class="btn primary" title="Previous image (←)">← Previous</button>
        <span id="preview-position" style="color:var(--text-muted); font-size:13px; min-width:50px; text-align:center;"></span>
        <button id="next-btn" type="button" class="btn primary" title="Next image (→)">Next →</button>
      </div>
      <a id="preview-download-btn" href="" download="" class="btn primary" style="display:inline-block; padding:8px 16px; text-decoration:none; font-size:13px; font-weight:500;">Download</a>
    </div>
  </div>
  <div id="preview-content" style="max-width:100%; overflow:auto;">
    <img id="preview-image" src="" alt="Preview" style="max-width:100%; max-height:70vh; display:block; border-radius:4px;">
  </div>
  <p id="preview-non-image" style="display:none; color:var(--text-muted); font-size:13px;">
    No preview available for this file type.
  </p>
</div>

{% if not tree %}
  <div class="card">
    <p class="empty">No archived images found yet. Run the archiver from the <a href="{{ url_for('dashboard') }}">Dashboard</a> to get started.</p>
  </div>
{% else %}
  {% for airport, years in tree.items() %}
  <details open>
    <summary class="card" style="margin-bottom:4px; font-weight:600; font-size:15px;">✈ {{ airport }}</summary>
    {% for year, months in years.items() %}
    <details style="margin-left:16px;">
      <summary class="card" style="margin-bottom:4px; font-weight:500;">
        {{ year }}
        <span class="badge badge-info" style="margin-left:8px">
          {% set ns = namespace(count=0) %}
          {% for month_data in months.values() %}
          {% for day_data in month_data.values() %}
          {% for camera, files in day_data.items() %}
          {% set ns.count = ns.count + (files|length) %}
          {% endfor %}
          {% endfor %}
          {% endfor %}
          {{ ns.count }} file(s)
        </span>
      </summary>
      {% for month, days in months.items() %}
      <details style="margin-left:16px;">
      <summary class="card" style="margin-bottom:4px;">
        {{ year }}-{{ month }}
      </summary>
        {% for day, cameras in days.items() %}
        {% for camera, files in cameras.items() %}
        <div class="card" style="margin-left:16px; margin-bottom:8px;">
          <h2>{{ airport }} &mdash; {{ camera }} &mdash; {{ year }}-{{ month }}-{{ day }}</h2>
          {% if files %}
            <div style="overflow-x:auto;">
              <table style="width:100%; border-collapse:collapse; font-size:12px; font-family:monospace;">
                <thead>
                  <tr style="border-bottom:1px solid var(--border); text-align:left; color:var(--text-muted);">
                    <th style="padding:4px 8px;">#</th>
                    <th style="padding:4px 8px;">Filename</th>
                  </tr>
                </thead>
                <tbody>
                  {% set image_exts = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'] %}
                  {% set ns = namespace(images=[]) %}
                  {% for fname in files %}
                    {% set ext = fname.split('.')|last|lower %}
                    {% if ext in image_exts %}
                      {% set _ = ns.images.append({'path': airport ~ '/' ~ year ~ '/' ~ month ~ '/' ~ day ~ '/' ~ camera ~ '/' ~ fname, 'filename': fname, 'index': ns.images|length}) %}
                    {% endif %}
                  {% endfor %}
                  {% for fname in files %}
                  <tr style="border-bottom:1px solid var(--border);" class="file-row">
                    <td style="padding:4px 8px; color:var(--text-muted);">{{ loop.index }}</td>
                    <td style="padding:4px 8px;">
                      {% set ext = fname.split('.')|last|lower %}
                      {% set img_entry = ns.images|selectattr('filename', 'equalto', fname)|first %}
                      {% set img_index = img_entry.index if img_entry else -1 %}
                      <a href="{{ url_for('serve_archive_file', subpath=airport ~ '/' ~ year ~ '/' ~ month ~ '/' ~ day ~ '/' ~ camera ~ '/' ~ fname) }}"
                         class="file-link"
                         data-path="{{ airport }}/{{ year }}/{{ month }}/{{ day }}/{{ camera }}/{{ fname }}"
                         data-filename="{{ fname }}"
                         data-siblings="{{ ns.images|tojson }}"
                         data-index="{{ img_index }}">
                        {{ fname }}
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="empty">No files.</p>
          {% endif %}
        </div>
        {% endfor %}
        {% endfor %}
      </details>
      {% endfor %}
    </details>
    {% endfor %}
  </details>
  {% endfor %}
{% endif %}

<script>
(function() {
  const panel = document.getElementById('preview-panel');
  const img = document.getElementById('preview-image');
  const filenameEl = document.getElementById('preview-filename');
  const timestampEl = document.getElementById('preview-timestamp');
  const nonImageEl = document.getElementById('preview-non-image');
  const downloadBtn = document.getElementById('preview-download-btn');
  const navEl = document.getElementById('preview-nav');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const positionEl = document.getElementById('preview-position');

  let siblings = [];
  let currentIndex = -1;
  let basePath = "{{ url_for('serve_archive_file', subpath='') }}";
  if (basePath && !basePath.endsWith('/')) basePath += '/';

  function parseTimestampFromFilename(filename) {
    const base = filename.replace(/\.[^.]+$/, '');
    const parts = base.split('_');
    if (parts.length >= 2) {
      const first = parts[0];
      if (/^\d{10,}$/.test(first)) {
        const d = new Date(parseInt(first, 10) * 1000);
        return d.toISOString().replace('T', ' ').replace(/\.\d{3}Z$/, ' UTC');
      }
      if (/^\d{8}$/.test(first) && /^\d{6}$/.test(parts[1])) {
        const y = first.slice(0, 4), m = first.slice(4, 6), d = first.slice(6, 8);
        const h = parts[1].slice(0, 2), min = parts[1].slice(2, 4), s = parts[1].slice(4, 6);
        return y + '-' + m + '-' + d + ' ' + h + ':' + min + ':' + s + ' UTC';
      }
    }
    return null;
  }

  function showImage(url, filename, isImage) {
    filenameEl.textContent = filename;
    const ts = parseTimestampFromFilename(filename);
    timestampEl.textContent = ts ? ts : '';
    timestampEl.style.display = ts ? 'inline' : 'none';
    downloadBtn.href = url;
    downloadBtn.download = filename;
    if (isImage) {
      img.style.display = 'block';
      img.src = url;
      nonImageEl.style.display = 'none';
    } else {
      img.style.display = 'none';
      img.src = '';
      nonImageEl.style.display = 'block';
    }
  }

  function updateNav() {
    if (siblings.length === 0) {
      navEl.style.display = 'none';
      return;
    }
    navEl.style.display = 'flex';
    prevBtn.disabled = currentIndex <= 0;
    nextBtn.disabled = currentIndex >= siblings.length - 1;
    positionEl.textContent = (currentIndex + 1) + ' / ' + siblings.length;
  }

  function goToIndex(idx) {
    if (idx < 0 || idx >= siblings.length) return;
    currentIndex = idx;
    const s = siblings[idx];
    const url = basePath + s.path;
    showImage(url, s.filename, true);
    updateNav();
  }

  function handleKeydown(e) {
    if (!panel || getComputedStyle(panel).display === 'none') return;
    if (siblings.length <= 1) return;
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      e.stopPropagation();
      if (currentIndex > 0) goToIndex(currentIndex - 1);
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      e.stopPropagation();
      if (currentIndex < siblings.length - 1) goToIndex(currentIndex + 1);
    }
  }

  // Capture phase so arrow keys work regardless of focus (e.g. after scrolling)
  document.addEventListener('keydown', handleKeydown, true);

  prevBtn.addEventListener('click', function() {
    if (currentIndex > 0) goToIndex(currentIndex - 1);
  });
  nextBtn.addEventListener('click', function() {
    if (currentIndex < siblings.length - 1) goToIndex(currentIndex + 1);
  });

  document.querySelectorAll('.file-link').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.getAttribute('href');
      const filename = this.getAttribute('data-filename');
      const ext = filename.split('.').pop().toLowerCase();
      const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'];

      try {
        siblings = JSON.parse(this.getAttribute('data-siblings') || '[]');
        currentIndex = parseInt(this.getAttribute('data-index'), 10);
      } catch (_) {
        siblings = [];
        currentIndex = -1;
      }

      panel.style.display = 'block';
      showImage(url, filename, imageExts.includes(ext));

      if (imageExts.includes(ext) && siblings.length > 0 && currentIndex >= 0) {
        updateNav();
      } else {
        navEl.style.display = 'none';
      }

      panel.focus();
      panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });
})();
</script>
{% endblock %}
